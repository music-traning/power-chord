<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Power Chord Academy</title>

    <link rel="icon" type="image/png" href="./icon-192.png">
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <meta name="description"
        content="ã‚®ã‚¿ãƒ¼ã®æŒ‡æ¿ï¼ˆãƒ•ãƒ¬ãƒƒãƒˆãƒœãƒ¼ãƒ‰ï¼‰ã®éŸ³åã‚’ã‚²ãƒ¼ãƒ æ„Ÿè¦šã§ãƒã‚¹ã‚¿ãƒ¼ã§ãã‚‹ç„¡æ–™Webã‚¢ãƒ—ãƒªã€‚ãƒ‘ãƒ¯ãƒ¼ã‚³ãƒ¼ãƒ‰ã€éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ã‚¤ãƒ¤ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æœ€é©ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã§ä»Šã™ãéŠã¹ã¾ã™ã€‚">
    <meta name="keywords" content="ã‚®ã‚¿ãƒ¼,æŒ‡æ¿,éŸ³å,è¦šãˆæ–¹,ãƒ‘ãƒ¯ãƒ¼ã‚³ãƒ¼ãƒ‰,éŸ³æ„Ÿ,ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°,ã‚¢ãƒ—ãƒª,ç„¡æ–™,ã‚²ãƒ¼ãƒ ">
    <meta name="author" content="Universal Make Associate">
    <meta name="robots" content="index, follow">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#00d2ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PCA Glass">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <title>Power Chord Academy: Glass Edition [Refined]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&family=Noto+Sans+JP:wght@300;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at 50% 10%, #1a2a3a 0%, #050505 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #00d2ff;
            --primary-glow: rgba(0, 210, 255, 0.4);
            --accent: #ff0055;
            --success: #00ff9d;
            --gold: #ffcc00;
            --text-main: #ffffff;
            --font-main: 'Inter', 'Noto Sans JP', sans-serif;
            --radius-lg: 24px;
            --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        [v-cloak] {
            display: none !important;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Animations */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .slide-up-enter-active {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-up-enter-from {
            transform: translateY(50px);
            opacity: 0;
        }

        @keyframes flashHint {
            0% {
                background: rgba(255, 204, 0, 0.2);
                box-shadow: 0 0 0 rgba(255, 204, 0, 0);
            }

            50% {
                background: rgba(255, 204, 0, 0.6);
                box-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            }

            100% {
                background: rgba(255, 204, 0, 0.2);
                box-shadow: 0 0 0 rgba(255, 204, 0, 0);
            }
        }

        /* UI Components */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-main);
            text-transform: uppercase;
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
            border: none;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-accent {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn:disabled {
            opacity: 0.5;
            filter: grayscale(1);
            cursor: not-allowed;
        }

        .btn-reset {
            background: transparent;
            border: none;
            color: #666;
            font-size: 0.8rem;
            margin-top: 30px;
            text-decoration: underline;
            cursor: pointer;
            padding: 10px;
        }

        .btn-reset:hover {
            color: #888;
        }

        /* Screens */
        .screen-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            z-index: 10;
        }

        .hero-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .logo-title {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900;
            background: linear-gradient(to right, #fff, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -2px;
        }

        .logo-sub {
            color: var(--primary);
            letter-spacing: 4px;
            font-weight: 700;
            margin-bottom: 2rem;
        }

        .settings-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 50;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            cursor: pointer;
            color: #fff;
        }

        .drum-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.3s;
        }

        .drum-toggle.active {
            border-color: var(--success);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);
        }

        .drum-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #444;
        }

        .drum-toggle.active .drum-indicator {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .list-grid {
            display: grid;
            gap: 15px;
            padding-bottom: 80px;
            width: 100%;
        }

        .lesson-card {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(20, 20, 20, 0.8);
        }

        .lesson-card.locked {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .lesson-card.active {
            border-color: var(--primary);
            background: rgba(0, 210, 255, 0.05);
        }

        .lesson-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        /* Game Screen */
        .game-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            margin-bottom: 5px;
        }

        /* Flexbox Layout for Battle Stage to prevent overlap */
        .battle-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            /* ã‚¢ã‚¤ãƒ†ãƒ ã¨ã‚³ãƒ¼ãƒ‰åã®é–“ã«å‡ç­‰ãªã‚¹ãƒšãƒ¼ã‚¹ */
            align-items: center;
            position: relative;
            min-height: 0;
            /* Flexbox overflow fix */
        }

        .target-display {
            text-align: center;
            position: relative;
            z-index: 2;
            animation: pulse 2s infinite ease-in-out;
        }

        .target-chord {
            font-size: clamp(4rem, 12vw, 7rem);
            /* å°‘ã—ã‚µã‚¤ã‚ºèª¿æ•´ */
            font-weight: 900;
            line-height: 1;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.03);
            }
        }

        /* Fretboard */
        .fretboard-container {
            width: 100%;
            padding: 15px 0;
            background: #222;
            border-top: 4px solid #444;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.8);
            flex-shrink: 0;
            z-index: 100;
            margin-bottom: max(20px, env(safe-area-inset-bottom));
            border-radius: 12px;
            border-bottom: 4px solid #111;
        }

        .string-row {
            display: flex;
            height: 50px;
            /* å°‘ã—ã‚¹ãƒªãƒ ã« */
            align-items: center;
            position: relative;
        }

        .string-marker {
            width: 50px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2rem;
            z-index: 2;
            color: #fff;
            text-shadow: 0 1px 2px #000;
        }

        .string-line {
            position: absolute;
            left: 50px;
            right: 0;
            height: 3px;
            top: 50%;
            margin-top: -1.5px;
            background: #888;
            pointer-events: none;
            z-index: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .frets-scroll {
            flex: 1;
            display: flex;
            padding-right: 10px;
        }

        .fret-zone {
            flex: 1;
            height: 100%;
            border-right: 2px solid #666;
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
            z-index: 1;
            touch-action: manipulation;
        }

        .fret-zone:active {
            background: var(--primary) !important;
            opacity: 0.6;
        }

        /* å¿ƒçœ¼ã®å¼·åŒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .fret-zone.hint {
            background: rgba(255, 204, 0, 0.4);
            animation: flashHint 0.8s infinite alternate;
            border: 2px solid var(--gold);
        }

        .pos-dot {
            width: 14px;
            height: 14px;
            background: #bbb;
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 0 5px #000;
            z-index: 2;
        }

        .fret-num {
            position: absolute;
            bottom: 2px;
            font-size: 0.6rem;
            color: #666;
        }

        /* Items - é‡ãªã‚Šé˜²æ­¢ã®ãŸã‚ absolute ã‚’ã‚„ã‚ã€ãƒ•ãƒ­ãƒ¼é…ç½®ã«ã™ã‚‹ */
        .items-dock {
            /* position: absolute;  â† å»ƒæ­¢ */
            /* bottom: 10px; left: 50%; transform: translateX(-50%); â† å»ƒæ­¢ */
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 40px;
            border: 1px solid #444;
            z-index: 150;
        }

        .dock-item {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            filter: grayscale(1);
            opacity: 0.7;
            color: #fff;
            position: relative;
            transition: 0.2s;
        }

        .dock-item.has-stock {
            filter: grayscale(0);
            opacity: 1;
        }

        .dock-item:active {
            transform: scale(0.9);
        }

        .dock-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .effect-text {
            position: absolute;
            font-weight: 900;
            font-size: 2.5rem;
            pointer-events: none;
            animation: floatUp 0.6s forwards;
            z-index: 50;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
        }

        @keyframes floatUp {
            0% {
                transform: translate(-50%, 0) scale(0.5);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -80px) scale(1.5);
                opacity: 0;
            }
        }

        .bars-container {
            width: 100%;
            margin-bottom: 10px;
        }

        .bar-track {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            padding: 30px;
            color: #eee;
            background: #111;
            border: 1px solid #333;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .app-footer {
            margin-top: auto;
            padding: 15px;
            text-align: center;
            font-size: 0.8rem;
            color: #aaa;
            background: #050505;
            border-top: 1px solid #111;
            z-index: 100;
            position: relative;
        }

        .manual-section h3 {
            color: var(--gold);
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 20px;
        }

        .manual-section ul {
            padding-left: 20px;
            text-align: left;
        }

        .manual-section li {
            margin-bottom: 8px;
        }

        .manual-section b {
            color: var(--primary);
        }
    </style>
</head>

<body>

    <div id="app" v-cloak>

        <transition name="fade">
            <div v-if="gameState === 'title'" class="screen-container">
                <div class="settings-bar">
                    <div class="icon-btn" @click="toggleLang">{{ lang === 'ja' ? 'EN' : 'JP' }}</div>
                    <div class="icon-btn" @click="showManual = true"><i class="fa-solid fa-question"></i></div>
                </div>

                <div class="hero-section">
                    <h1 class="logo-title">POWER CHORD<br>ACADEMY</h1>
                    <div class="logo-sub">GLASS EDITION</div>

                    <div class="drum-toggle" :class="{active: isDrumActive}" @click="isDrumActive = !isDrumActive">
                        <div class="drum-indicator"></div>
                        <div style="font-weight: bold; font-size: 0.9rem;">
                            <i class="fa-solid fa-drum"></i> {{ t.drums }}: {{ isDrumActive ? 'ON' : 'OFF' }}
                        </div>
                    </div>

                    <div style="color: var(--gold); font-weight: bold; margin-bottom: 20px; font-size: 1.2rem;">
                        <i class="fa-solid fa-coins"></i> {{ savedData.gold }} G
                    </div>

                    <button class="btn btn-primary"
                        style="min-width: 220px; margin-bottom: 15px; font-size: 1.1rem; padding: 15px;"
                        @click="goToMenu">
                        <i class="fa-solid fa-play"></i> {{ t.start }}
                    </button>
                    <button class="btn btn-accent" style="min-width: 220px;" @click="goToShop">
                        <i class="fa-solid fa-store"></i> {{ t.shop }}
                    </button>

                    <button class="btn-reset" @click="resetGameData">
                        <i class="fa-solid fa-trash"></i> {{ t.resetData }}
                    </button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="gameState === 'menu'" class="screen-container">
                <div class="game-top-bar">
                    <h2 style="margin:0;">{{ t.lessonList }}</h2>
                    <button class="btn" style="padding: 8px 16px; font-size: 0.8rem;" @click="gameState='title'">{{
                        t.back }}</button>
                </div>
                <div class="list-grid">
                    <div v-for="lvl in 50" :key="lvl" class="glass-panel lesson-card" :class="{
                    'locked': lvl > savedData.maxLevel,
                    'active': lvl === savedData.maxLevel,
                    'cleared': lvl < savedData.maxLevel
                 }" @click="selectLevel(lvl)">
                        <div class="lesson-icon">
                            <i v-if="lvl < savedData.maxLevel" class="fa-solid fa-check"
                                style="color: var(--success);"></i>
                            <i v-else-if="lvl === savedData.maxLevel" class="fa-solid fa-play"
                                style="color: var(--primary);"></i>
                            <i v-else class="fa-solid fa-lock" style="color: #666;"></i>
                        </div>
                        <div style="flex:1;">
                            <div
                                style="font-size: 0.75rem; color: var(--primary); font-weight: bold; text-transform: uppercase;">
                                LESSON {{ lvl }}</div>
                            <div style="font-weight: bold; margin-bottom: 4px; color: #fff;">{{ getMissionTitle(lvl) }}
                            </div>
                            <div style="font-size: 0.8rem; color: #888;">{{ getMissionDesc(lvl) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="gameState === 'briefing'" class="modal-overlay">
                <div class="glass-panel modal-content slide-up">
                    <div style="color: var(--primary); font-weight: bold; margin-bottom: 10px;">LESSON {{ currentLevel
                        }}</div>
                    <h2 style="margin: 0 0 15px 0; font-size: 1.8rem; line-height: 1.2;">{{
                        getMissionTitle(currentLevel) }}</h2>
                    <p style="color: #bbb; line-height: 1.6; font-size: 0.9rem;">{{ getMissionDesc(currentLevel) }}</p>

                    <div
                        style="background: rgba(255, 204, 0, 0.1); border-left: 3px solid var(--gold); padding: 15px; margin: 20px 0; text-align: left;">
                        <i class="fa-solid fa-lightbulb" style="color: var(--gold); margin-right: 8px;"></i>
                        <span style="font-size: 0.9rem; color: #ddd;">
                            {{ t[getLevelInfo(currentLevel).advKey] }}
                        </span>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" @click="startMission">{{
                        t.startLesson }}</button>
                    <button class="btn" style="width: 100%; border:none; color: #888;" @click="gameState='menu'">{{
                        t.cancel }}</button>
                </div>
            </div>
        </transition>

        <div v-if="gameState === 'playing'" class="screen-container"
            style="padding: 20px 20px 0 20px; justify-content: flex-start;">

            <div style="padding-bottom: 15px; flex-shrink: 0; z-index: 10;">
                <div class="game-top-bar">
                    <div style="color: var(--primary); font-weight: 700;">LESSON {{ currentLevel }}</div>
                    <div style="text-align: right;">
                        <button class="btn" style="padding:4px 12px; font-size:0.7rem; margin-bottom:5px;"
                            @click="abortMission">{{ t.cancel }}</button>
                        <div style="font-family: monospace; font-size: 1.1rem; color: #fff;">SCORE: <span
                                style="color:var(--gold);">{{ score }}</span></div>
                        <div v-if="combo > 1"
                            style="color: var(--accent); font-weight:900; font-size: 1.2rem; text-shadow: 0 0 10px var(--accent);">
                            {{ combo }} COMBO!
                        </div>
                    </div>
                </div>
                <div class="bars-container">
                    <div class="bar-track">
                        <div class="bar-fill"
                            :style="{width: (progress/reqProgress)*100 + '%', background: 'var(--success)'}"></div>
                    </div>
                    <div class="bar-track" style="height: 4px;">
                        <div class="bar-fill"
                            :style="{width: timerValue + '%', background: activeEffects.clock ? '#00ccff' : 'var(--gold)'}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="battle-stage" @mousedown="resumeAudioForce">
                <div class="target-display" v-if="currentTarget">
                    <div style="font-size: 1.2rem; color: #aaa; font-weight: 500; margin-bottom: 10px;">{{
                        currentTarget.string }} {{ t.stringRoot }}</div>
                    <div class="target-chord" :style="{color: currentTarget.string === 6 ? '#ff4444' : '#44aaff'}">
                        {{ currentTarget.note }}<span style="font-size: 0.5em; opacity: 0.7;">5</span>
                    </div>
                </div>

                <div class="items-dock" v-if="savedData && savedData.inventory">
                    <div class="dock-item" :class="{'has-stock': savedData.inventory.clock > 0}"
                        @click="useItem('clock')" :style="{color: activeEffects.clock ? 'var(--primary)' : '#fff'}">
                        <i class="fa-solid fa-hourglass-half"></i>
                        <div class="dock-badge">{{ savedData.inventory.clock || 0 }}</div>
                    </div>
                    <div class="dock-item" :class="{'has-stock': savedData.inventory.shield > 0}"
                        @click="useItem('shield')" :style="{color: activeEffects.shield ? 'var(--primary)' : '#fff'}">
                        <i class="fa-solid fa-shield-halved"></i>
                        <div class="dock-badge">{{ savedData.inventory.shield || 0 }}</div>
                    </div>
                    <div class="dock-item" :class="{'has-stock': savedData.inventory.eye > 0}" @click="useItem('eye')"
                        :style="{color: activeEffects.eye ? 'var(--primary)' : '#fff'}">
                        <i class="fa-solid fa-eye"></i>
                        <div class="dock-badge">{{ savedData.inventory.eye || 0 }}</div>
                    </div>
                </div>

                <div v-for="ef in hitEffects" :key="ef.id" class="effect-text"
                    :style="{left: ef.x + 'px', top: ef.y + 'px', color: ef.color, fontSize: ef.size}">
                    {{ ef.text }}
                </div>
            </div>

            <div class="fretboard-container" @mousedown="resumeAudioForce">
                <div class="string-row">
                    <div class="string-marker" style="color: #ff4444;">6</div>
                    <div class="string-line"></div>
                    <div class="frets-scroll">
                        <div v-for="(n, i) in 13" :key="'s6-'+i" class="fret-zone"
                            :class="{'hint': activeEffects.eye && currentTarget && currentTarget.string===6 && currentTarget.fret===i}"
                            @touchstart.prevent="handleInput($event, 6, i)" @mousedown="handleInput($event, 6, i)">
                            <div v-if="[3,5,7,9,12].includes(i)" class="pos-dot"></div>
                            <div class="fret-num">{{ i }}</div>
                        </div>
                    </div>
                </div>
                <div class="string-row">
                    <div class="string-marker" style="color: #44aaff;">5</div>
                    <div class="string-line"></div>
                    <div class="frets-scroll">
                        <div v-for="(n, i) in 13" :key="'s5-'+i" class="fret-zone"
                            :class="{'hint': activeEffects.eye && currentTarget && currentTarget.string===5 && currentTarget.fret===i}"
                            @touchstart.prevent="handleInput($event, 5, i)" @mousedown="handleInput($event, 5, i)">
                            <div v-if="[3,5,7,9,12].includes(i)" class="pos-dot"></div>
                            <div class="fret-num">{{ i }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <transition name="fade">
            <div v-if="gameState === 'shop'" class="screen-container">
                <div class="game-top-bar">
                    <h2>{{ t.shop }}</h2>
                    <button class="btn" @click="gameState='title'">{{ t.back }}</button>
                </div>
                <div style="text-align: right; color: var(--gold); margin-bottom: 20px; font-weight: bold;">
                    {{ t.funds }}: {{ savedData.gold }} G
                </div>

                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; color: #888;">{{ t.items }}</h3>
                <div class="list-grid"
                    style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); display:grid;">
                    <div v-for="item in shopItems" :key="item.id" class="glass-panel"
                        style="padding: 15px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">{{ item.icon }}</div>
                        <div style="font-weight: bold; font-size: 0.9rem;">{{ lang==='ja'?item.name:item.nameEn }}</div>
                        <div style="color: var(--gold); margin: 5px 0;">{{ item.cost }} G</div>
                        <button class="btn btn-primary" style="padding: 5px 15px; width: 100%; font-size: 0.8rem;"
                            @click="buyItem(item.id, item.cost)" :disabled="savedData.gold < item.cost">{{ t.buy
                            }}</button>
                        <div style="font-size: 0.7rem; color: #888; margin-top: 5px;">{{ t.owned }}: {{
                            savedData.inventory[item.id] || 0 }}</div>
                    </div>
                </div>

                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; color: #888; margin-top: 30px;">{{
                    t.soundGear }}</h3>
                <div class="list-grid">
                    <div v-for="gear in gearList" :key="gear.id" class="glass-panel"
                        style="padding: 15px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap: 15px;">
                            <div style="font-size: 1.5rem;">{{ gear.icon }}</div>
                            <div style="text-align: left;">
                                <div style="font-weight: bold;">{{ lang==='ja' ? gear.name : gear.nameEn }}</div>
                                <div style="font-size: 0.8rem; color: #888;">{{ gear.cost }} G</div>
                            </div>
                        </div>
                        <div v-if="!savedData.unlockedGears.includes(gear.id)">
                            <button class="btn btn-accent" @click="buyGear(gear.id, gear.cost)"
                                :disabled="savedData.gold < gear.cost">{{ t.buy }}</button>
                        </div>
                        <div v-else>
                            <button v-if="savedData.equippedGear !== gear.id" class="btn" @click="equipGear(gear.id)">{{
                                t.equip }}</button>
                            <span v-else style="color: var(--success); font-weight: bold; font-size: 0.9rem;"><i
                                    class="fa-solid fa-check"></i> {{ t.owned }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="gameState === 'result'" class="modal-overlay">
                <div class="glass-panel modal-content slide-up">
                    <div v-if="result.isClear">
                        <i class="fa-solid fa-crown"
                            style="font-size: 3rem; color: var(--gold); margin-bottom: 15px;"></i>
                        <h2 style="color: var(--success); font-size: 2rem; margin: 0;">{{ t.clearTitle }}</h2>
                        <p>{{ t.clearMsg }}</p>
                    </div>
                    <div v-else>
                        <i class="fa-solid fa-heart-crack"
                            style="font-size: 3rem; color: var(--accent); margin-bottom: 15px;"></i>
                        <h2 style="color: var(--accent); font-size: 2rem; margin: 0;">{{ t.failTitle }}</h2>
                        <p>{{ t.failMsg }}</p>
                    </div>

                    <div style="font-size: 2.5rem; font-weight: 900; margin: 20px 0;">{{ score }} <span
                            style="font-size: 1rem;">PTS</span></div>
                    <div style="color: var(--gold); margin-bottom: 30px; font-size: 1.2rem;">+{{ result.reward }} G
                    </div>

                    <div style="display: grid; gap: 10px;">
                        <button v-if="result.isClear && currentLevel < 50" class="btn btn-primary"
                            @click="nextMission">{{ t.next }}</button>
                        <button v-else class="btn btn-primary" @click="startMission">{{ t.retry }}</button>
                        <button class="btn" @click="goToMenu">{{ t.lessonList }}</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showManual" class="modal-overlay">
                <div class="glass-panel modal-content slide-up">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <h2 style="margin:0; color: var(--primary);">{{ t.manualTitle }}</h2>
                        <button class="icon-btn" @click="showManual = false"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div v-html="t.manualContent" style="line-height: 1.6; color: #ddd;"></div>
                </div>
            </div>
        </transition>

        <footer class="app-footer">
            Â©2026 <a href="https://note.com/jazzy_begin">buro</a>
        </footer>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    gameState: 'title',
                    showManual: false,
                    lang: 'ja',
                    isDrumActive: true,

                    dict: {
                        ja: {
                            start: "ç·´ç¿’ã‚’å§‹ã‚ã‚‹", shop: "æ©Ÿæã‚·ãƒ§ãƒƒãƒ—", lessonList: "ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§",
                            back: "æˆ»ã‚‹", funds: "æ‰€æŒé‡‘", buy: "è³¼å…¥", owned: "æ‰€æŒ", equip: "è£…å‚™",
                            items: "ã‚µãƒãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ", soundGear: "ã‚µã‚¦ãƒ³ãƒ‰æ©Ÿæ", drums: "ãƒ‰ãƒ©ãƒ ",
                            teacherPoint: "å…ˆç”Ÿã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹", startLesson: "ãƒ¬ãƒƒã‚¹ãƒ³é–‹å§‹", cancel: "ä¸­æ–­",
                            stringRoot: "å¼¦ãƒ«ãƒ¼ãƒˆ", clearTitle: "ç´ æ™´ã‚‰ã—ã„ï¼", clearMsg: "ã‚ˆãã§ãã¾ã—ãŸã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã¿ã¾ã—ã‚‡ã†ã€‚",
                            failTitle: "æ®‹å¿µ...", failMsg: "è«¦ã‚ãªã„ã§ã€‚ã‚‚ã†ä¸€åº¦ãƒˆãƒ©ã‚¤ã—ã¾ã—ã‚‡ã†ã€‚",
                            next: "æ¬¡ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¸", retry: "ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦",
                            resetData: "ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–",
                            resetConfirm: "æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚",

                            adv_basic: "ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¯(â—)ã‚’ä¿¡ã˜ã‚ã€‚3, 5, 7, 9, 12ãƒ•ãƒ¬ãƒƒãƒˆã«ã‚ã‚‹ã€‚",
                            adv_low: "8ãƒ•ãƒ¬ãƒƒãƒˆã¯Cã€10ãƒ•ãƒ¬ãƒƒãƒˆã¯Dã ã€‚ä½ç½®é–¢ä¿‚ã‚’ä½“ã§è¦šãˆã‚ã€‚",
                            adv_string5: "5å¼¦1ãƒ•ãƒ¬ãƒƒãƒˆã¯Bbã ã€‚6å¼¦ã¨ã¯æ™¯è‰²ãŒé•ã†ãã€‚æ³¨æ„ã›ã‚ˆã€‚",
                            adv_mix: "6å¼¦Gã®çœŸä¸‹ã¯Cã€6å¼¦Aã®çœŸä¸‹ã¯Dã ã€‚ã“ã®æ³•å‰‡ã‚’ä½¿ãˆã€‚",
                            adv_final: "ç›´æ„Ÿã‚’ç ”ãæ¾„ã¾ã›ã€‚è€ƒãˆã‚‹ãªã€æ„Ÿã˜ã‚ã€‚",

                            manualTitle: "ç†±ãé­‚ã®ã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯",
                            manualContent: `
                        <div class="manual-section">
                        <p>ã‚ˆã†ã“ãã€Power Chord Academyã¸ã€‚<br>ã“ã“ã¯æœ€çŸ­ã§ã€ŒæŒ‡æ¿ã®åœ°ç†ã€ã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ãŸã‚ã®ç§˜å¯†åŸºåœ°ã ã€‚</p>
                        <h3>åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ«</h3>
                        <p>ç”»é¢ã«<b>ã€Œ6å¼¦ãƒ»Gã€</b>ã®ã‚ˆã†ãªæŒ‡ä»¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚å›ã¯ã‚®ã‚¿ãƒ¼ã®æŒ‡æ¿ï¼ˆç”»é¢ä¸‹ã®ãƒ•ãƒ¬ãƒƒãƒˆãƒœãƒ¼ãƒ‰ï¼‰ã‹ã‚‰ã€æ­£è§£ã®å ´æ‰€ã‚’ç¬æ™‚ã«ã‚¿ãƒƒãƒ—ã›ã‚ˆã€‚</p>
                        <h3>ã‚¹ã‚³ã‚¢ã¨ã‚³ãƒ³ãƒœ</h3>
                        <p>æ­£è§£ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒå¢—ãˆã€åˆ¶é™æ™‚é–“ãŒå°‘ã—å›å¾©ã™ã‚‹ã€‚é€£ç¶šã§æ­£è§£ã™ã‚‹ã¨<b>ã€Œã‚³ãƒ³ãƒœã€</b>ãŒç™ºç”Ÿã—ã€ã‚¹ã‚³ã‚¢ãŒè·³ã­ä¸ŠãŒã‚‹ã€‚<b>å›ç­”é€Ÿåº¦ãŒé€Ÿã„ã»ã©ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆ</b>ã‚‚å…¥ã‚‹ãï¼</p>
                        <h3>ã‚¢ã‚¤ãƒ†ãƒ ã®åŠ›</h3>
                        <ul>
                            <li><b>â³ ç ‚æ™‚è¨ˆï¼š</b>æ™‚é–“ã‚’5ç§’é–“æ­¢ã‚ã‚‹ã€‚è½ã¡ç€ã„ã¦è€ƒãˆãŸã„æ™‚ã«ä½¿ãˆã€‚</li>
                            <li><b>ğŸ›¡ï¸ é‰„å£ã®ç›¾ï¼š</b>ãƒŸã‚¹ã‚’1å›ã ã‘ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚ãƒŸã‚¹ã—ãŸç¬é–“ã«è‡ªå‹•ã§ç™ºå‹•ã™ã‚‹ã€‚</li>
                            <li><b>ğŸ‘ï¸ å¿ƒçœ¼ï¼š</b>æ­£è§£ã®å ´æ‰€ãŒ<b>ãƒ”ã‚«ãƒ”ã‚«å…‰ã£ã¦</b>è¦‹ãˆã‚‹ã€‚ã“ã“ãã¨ã„ã†æ™‚ã®åˆ‡ã‚Šæœ­ã ã€‚</li>
                        </ul>
                        <h3>ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (PWA)</h3>
                            <p>ã“ã®ã‚µã‚¤ãƒˆã¯PWAã«å¯¾å¿œã—ã¦ã„ã‚‹ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚Œã°ã€<b>ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</b>ã§å¿«é©ã«ä¿®è¡ŒãŒã§ãã‚‹ãã€‚</p>
                            <ul>
                                <li><b>iPhone (Safari):</b> ç”»é¢ä¸‹ã®ã€Œå…±æœ‰ <i class="fa-solid fa-arrow-up-from-bracket"></i>ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€<b>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</b>ã‚’é¸æŠã›ã‚ˆã€‚</li>
                                <li><b>Android (Chrome):</b> å³ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œï¸™ã€ã‹ã‚‰<b>ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€</b>ã¾ãŸã¯<b>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</b>ã‚’é¸ã¹ã€‚</li>
                            </ul>
                        </div>
                    `
                        },
                        en: {
                            start: "Start Practice", shop: "Gear Shop", lessonList: "Lesson List",
                            back: "Back", funds: "Funds", buy: "Buy", owned: "In Stock", equip: "Equip",
                            items: "Support Items", soundGear: "Sound Gear", drums: "Drums",
                            teacherPoint: "Teacher's Tip", startLesson: "Start Lesson", cancel: "Abort",
                            stringRoot: "th String Root", clearTitle: "Excellent!", clearMsg: "Great job. Let's move to the next step.",
                            failTitle: "Don't give up...", failMsg: "Practice makes perfect. Try again!",
                            next: "Next Lesson", retry: "Try Again",
                            resetData: "Reset Save Data",
                            resetConfirm: "Are you sure you want to delete all data? This cannot be undone.",

                            adv_basic: "Trust the position markers (dots). They are at 3, 5, 7, 9, 12.",
                            adv_low: "8th fret is C, 10th is D. Memorize the distances.",
                            adv_string5: "5th String 1st fret is Bb. The view is different from the 6th string. Watch out.",
                            adv_mix: "Directly below 6th-G is C. Below 6th-A is D. Use this rule.",
                            adv_final: "Sharpen your intuition. Don't think, feel.",

                            manualTitle: "Soulful Guidebook",
                            manualContent: `
                        <div class="manual-section">
                        <p>Welcome to the Power Chord Academy.<br>This is your secret base to master the fretboard geography.</p>
                        <h3>Basic Rules</h3>
                        <p>A target like <b>"6th Str - G"</b> will appear. You must instantly tap the correct position on the fretboard below.</p>
                        <h3>Score & Combo</h3>
                        <p>Correct answers boost your score and time. Chain corrects for a <b>"Combo"</b> multiplier. <b>Faster answers yield massive Speed Bonuses!</b></p>
                        <h3>Power Items</h3>
                        <ul>
                            <li><b>â³ Hourglass:</b> Freezes time for 5 seconds. Use it to think calmly.</li>
                            <li><b>ğŸ›¡ï¸ Iron Shield:</b> Blocks one mistake automatically upon error.</li>
                            <li><b>ğŸ‘ï¸ Mind's Eye:</b> The correct answer will <b>flash intensely</b>. Your ace in the hole.</li>
                        </ul>
                        <h3>ğŸ“± Install App (PWA)</h3>
                            <p>This academy supports PWA. Add it to your home screen for the best <b>fullscreen & offline</b> experience.</p>
                            <ul>
                                <li><b>iPhone (Safari):</b> Tap the "Share <i class="fa-solid fa-arrow-up-from-bracket"></i>" button and select <b>"Add to Home Screen"</b>.</li>
                                <li><b>Android (Chrome):</b> Tap the menu "ï¸™" and select <b>"Install App"</b> or <b>"Add to Home Screen"</b>.</li>
                            </ul>
                        </div>
                    `
                        }
                    },

                    savedData: {
                        maxLevel: 1, gold: 500, inventory: { clock: 1, shield: 1, eye: 1 },
                        unlockedGears: ['standard'], equippedGear: 'standard'
                    },

                    shopItems: [
                        { id: 'clock', name: 'é­”æ³•ã®ç ‚æ™‚è¨ˆ', nameEn: 'Magic Hourglass', cost: 300, icon: 'â³' },
                        { id: 'shield', name: 'é‰„å£ã®ç›¾', nameEn: 'Iron Shield', cost: 500, icon: 'ğŸ›¡ï¸' },
                        { id: 'eye', name: 'å¿ƒçœ¼ã®ç§˜è–¬', nameEn: 'Mind\'s Eye Potion', cost: 200, icon: 'ğŸ‘ï¸' }
                    ],
                    gearList: [
                        { id: 'standard', name: 'Standard OD', nameEn: 'Standard OD', cost: 0, icon: 'ğŸ¸' },
                        { id: 'metal', name: 'Metal Zone', nameEn: 'Metal Zone', cost: 800, icon: 'âš¡' },
                        { id: 'fuzz', name: 'Vintage Fuzz', nameEn: 'Vintage Fuzz', cost: 1200, icon: 'ğŸ”¥' },
                        { id: 'clean', name: 'Jazz Clean', nameEn: 'Jazz Clean', cost: 500, icon: 'ğŸ’' }
                    ],

                    currentLevel: 1, score: 0, combo: 0, progress: 0, reqProgress: 5,
                    timerValue: 100, timerInterval: null,
                    currentTarget: null,
                    activeEffects: { clock: false, shield: false, eye: false },
                    hitEffects: [], effectId: 0,
                    result: { isClear: false, reward: 0 },

                    questionStartTime: 0, // [New] Speed Bonus Logic

                    allNotes: [
                        { note: 'F', string: 6, fret: 1 }, { note: 'G', string: 6, fret: 3 }, { note: 'A', string: 6, fret: 5 }, { note: 'B', string: 6, fret: 7 }, { note: 'C', string: 6, fret: 8 }, { note: 'D', string: 6, fret: 10 }, { note: 'E', string: 6, fret: 12 }, { note: 'E', string: 6, fret: 0 },
                        { note: 'B', string: 5, fret: 2 }, { note: 'C', string: 5, fret: 3 }, { note: 'D', string: 5, fret: 5 }, { note: 'E', string: 5, fret: 7 }, { note: 'F', string: 5, fret: 8 }, { note: 'G', string: 5, fret: 10 }, { note: 'A', string: 5, fret: 12 }, { note: 'A', string: 5, fret: 0 }, { note: 'Bb', string: 5, fret: 1 },
                        { note: 'F#', string: 6, fret: 2 }, { note: 'Ab', string: 6, fret: 4 }, { note: 'Bb', string: 6, fret: 6 }, { note: 'Db', string: 6, fret: 9 }, { note: 'Eb', string: 6, fret: 11 },
                        { note: 'Db', string: 5, fret: 4 }, { note: 'Eb', string: 5, fret: 6 }, { note: 'F#', string: 5, fret: 9 }, { note: 'Ab', string: 5, fret: 11 }
                    ]
                }
            },
            created() {
                this.synth = null;
                this.distortion = null;
                this.filter = null;
                this.reverb = null;
                this.drumKick = null;
                this.drumSnare = null;
                this.drumHat = null;
                this.drumLoop = null;
            },
            computed: { t() { return this.dict[this.lang]; } },
            mounted() {
                const saved = localStorage.getItem('pca_save_v1');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.maxLevel) this.savedData.maxLevel = parsed.maxLevel;
                        if (parsed.gold !== undefined) this.savedData.gold = parsed.gold;
                        if (parsed.unlockedGears) this.savedData.unlockedGears = parsed.unlockedGears;
                        if (parsed.equippedGear) this.savedData.equippedGear = parsed.equippedGear;
                        if (parsed.inventory) {
                            this.savedData.inventory = { ...this.savedData.inventory, ...parsed.inventory };
                        }
                    } catch (e) { console.error("Save data load error", e); }
                }

                // [Fix] iOS PWA Audio Unlock
                this.unlockAudio();
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        this.resumeAudioForce();
                    }
                });
            },
            methods: {
                unlockAudio() {
                    const unlock = async () => {
                        try {
                            await Tone.start();
                            if (Tone.context.state !== 'running') {
                                await Tone.context.resume();
                            }
                        } catch (e) { console.error("Unlock Error", e); }

                        if (Tone.context.state === 'running') {
                            window.removeEventListener('touchstart', unlock);
                            window.removeEventListener('touchend', unlock);
                            window.removeEventListener('click', unlock);
                        }
                    };
                    window.addEventListener('touchstart', unlock, { passive: true });
                    window.addEventListener('touchend', unlock, { passive: true });
                    window.addEventListener('click', unlock);
                },

                saveGame() { localStorage.setItem('pca_save_v1', JSON.stringify(this.savedData)); },
                toggleLang() { this.lang = this.lang === 'ja' ? 'en' : 'ja'; },

                resetGameData() {
                    if (confirm(this.t.resetConfirm)) {
                        localStorage.removeItem('pca_save_v1');
                        location.reload();
                    }
                },

                goToMenu() { this.stopGame(); this.gameState = 'menu'; },
                goToShop() { this.stopGame(); this.gameState = 'shop'; },
                abortMission() { this.stopGame(); this.gameState = 'menu'; },

                stopGame() {
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                    if (typeof Tone !== 'undefined' && Tone.Transport) {
                        Tone.Transport.stop();
                    }
                },

                selectLevel(lvl) {
                    if (lvl <= this.savedData.maxLevel) {
                        this.currentLevel = lvl;
                        this.gameState = 'briefing';
                    }
                },

                buyItem(id, cost) {
                    this.savedData.gold -= cost;
                    if (!this.savedData.inventory[id]) this.savedData.inventory[id] = 0;
                    this.savedData.inventory[id]++;
                    this.saveGame();
                },
                buyGear(id, cost) {
                    this.savedData.gold -= cost;
                    this.savedData.unlockedGears.push(id);
                    this.saveGame();
                },
                equipGear(id) {
                    this.savedData.equippedGear = id;
                    this.saveGame();
                    this.setupToneGear(id);
                },

                getMissionTitle(lvl) {
                    if (this.lang === 'en') return "Lesson " + lvl;
                    if (lvl <= 3) return "6å¼¦ã®åŸºç¤ (G, A, B)";
                    if (lvl <= 6) return "é–‹æ”¾å¼¦ã¨F";
                    if (lvl <= 10) return "6å¼¦ãƒ«ãƒ¼ãƒˆå®Œå…¨åˆ¶è¦‡";
                    if (lvl <= 13) return "5å¼¦ã¸ã®è»¢æˆ¦";
                    if (lvl <= 20) return "5å¼¦ãƒ«ãƒ¼ãƒˆå®Œå…¨åˆ¶è¦‡";
                    if (lvl <= 30) return "ç¸¦æ¨ªç„¡å°½ (6&5å¼¦)";
                    if (lvl <= 40) return "é»’éµã®é ˜åŸŸ (Sharp/Flat)";
                    return "å…è¨±çš†ä¼ (ALL KEYS)";
                },
                getMissionDesc(lvl) {
                    if (this.lang === 'en') return "Let's practice power chords.";
                    if (lvl <= 3) return "ã¾ãšã¯åŸºæœ¬ã¨ãªã‚‹3, 5, 7ãƒ•ãƒ¬ãƒƒãƒˆã®ä½ç½®ã‚’ä½“ã«åˆ»ã¿è¾¼ã‚ã€‚";
                    if (lvl <= 6) return "1ãƒ•ãƒ¬ãƒƒãƒˆ(F)ã¨é–‹æ”¾å¼¦(E)ãŒåŠ ã‚ã‚‹ã€‚ä½ã„éŸ³ã‚’æ„è­˜ã›ã‚ˆã€‚";
                    if (lvl <= 10) return "12ãƒ•ãƒ¬ãƒƒãƒˆã¾ã§ã®å…¨ã¦ã®ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒãƒ¼ãƒˆãŒå‡ºç¾ã™ã‚‹ã€‚";
                    if (lvl <= 13) return "æˆ¦å ´ã¯5å¼¦ã¸ã€‚3, 5, 7ãƒ•ãƒ¬ãƒƒãƒˆã®ä½ç½®é–¢ä¿‚ã¯6å¼¦ã¨åŒã˜ã ã€‚";
                    if (lvl <= 20) return "5å¼¦ã®å…¨ã¦ã®ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒãƒ¼ãƒˆã‚’æ”»ç•¥ã›ã‚ˆã€‚";
                    if (lvl <= 30) return "6å¼¦ã¨5å¼¦ãŒå…¥ã‚Šä¹±ã‚Œã‚‹ã€‚å¼¦ç§»å‹•ã®åå°„ç¥çµŒãŒè©¦ã•ã‚Œã‚‹ã€‚";
                    if (lvl <= 40) return "ã‚·ãƒ£ãƒ¼ãƒ—ãƒ»ãƒ•ãƒ©ãƒƒãƒˆã‚’å«ã‚€å…¨ã¦ã®éŸ³ãŒãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºç¾ã™ã‚‹ã€‚";
                    return "å…¨ã¦ã®è¦ç´ ãŒå«ã¾ã‚ŒãŸæœ€çµ‚è©¦é¨“ã€‚æ¥µé™ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã§æŒ‘ã‚ã€‚";
                },

                getLevelInfo(lvl) {
                    if (lvl <= 3) return { advKey: "adv_basic", pool: n => n.string === 6 && [3, 5, 7].includes(n.fret) };
                    if (lvl <= 10) return { advKey: "adv_low", pool: n => n.string === 6 && [0, 1, 3, 5, 7, 8, 10, 12].includes(n.fret) };
                    if (lvl <= 20) return { advKey: "adv_string5", pool: n => n.string === 5 && [0, 1, 2, 3, 5, 7, 8, 10, 12].includes(n.fret) };
                    if (lvl <= 30) return { advKey: "adv_mix", pool: n => [0, 1, 3, 5, 7, 8, 10, 12].includes(n.fret) };
                    return { advKey: "adv_final", pool: n => true };
                },

                async startMission() {
                    try {
                        await Tone.start();
                        await this.initAudio();
                        if (Tone.context.state !== 'running') await Tone.context.resume();
                    } catch (e) {
                        console.error("Audio Start Error", e);
                    }

                    this.gameState = 'playing';
                    this.score = 0; this.combo = 0; this.progress = 0;
                    this.reqProgress = 5 + Math.floor(this.currentLevel / 2);
                    this.timerValue = 100;
                    this.activeEffects = { clock: false, shield: false, eye: false };

                    this.nextQuestion();

                    Tone.Transport.stop();
                    Tone.Transport.position = 0;
                    Tone.Transport.bpm.value = 110 + (this.currentLevel);

                    if (this.isDrumActive) {
                        Tone.Transport.start();
                        if (this.drumLoop) this.drumLoop.start(0);
                    }

                    if (this.timerInterval) clearInterval(this.timerInterval);
                    const decay = 0.2 + (this.currentLevel * 0.05);
                    this.timerInterval = setInterval(() => {
                        if (!this.activeEffects.clock) this.timerValue -= decay;
                        if (this.timerValue <= 0) this.gameOver();
                    }, 50);
                },

                handleInput(e, s, f) {
                    this.resumeAudioForce();

                    let cx, cy;
                    if (e.type === 'touchstart') { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
                    else { cx = e.clientX; cy = e.clientY; }

                    const target = this.currentTarget;
                    if (!target) return;

                    // [New] Speed Calculation
                    const reactionTime = Date.now() - this.questionStartTime;
                    let speedBonus = 0;
                    if (reactionTime < 1000) speedBonus = 500;
                    else if (reactionTime < 2000) speedBonus = 300;
                    else if (reactionTime < 3000) speedBonus = 100;

                    if (target.string === s && target.fret === f) {
                        this.combo++;
                        // [New] Combo & Speed Score Logic
                        this.score += 100 + (this.combo * 50) + speedBonus + Math.floor(this.timerValue);

                        this.timerValue = Math.min(100, this.timerValue + 20);
                        this.progress++;
                        this.playPowerChord(target.note);

                        // Show Effect based on speed
                        const text = speedBonus >= 500 ? "EXCELLENT!" : "GOOD!";
                        const color = speedBonus >= 500 ? "var(--gold)" : "var(--success)";
                        this.spawnEffect(cx, cy, text, color, "2rem");

                        if (this.activeEffects.eye) this.activeEffects.eye = false;

                        if (this.progress >= this.reqProgress) this.missionClear();
                        else this.nextQuestion();
                    } else {
                        if (this.activeEffects.shield) {
                            this.activeEffects.shield = false;
                            this.spawnEffect(cx, cy, "SHIELD BLOCK!", "#fff", "1.5rem");
                            // ç›¾ãŒç™ºå‹•ã—ãŸæ¼”å‡ºï¼ˆåœ¨åº«ãŒæ¸›ã‚‹ãªã©ã¯HTMLå´ã§ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«åæ˜ ï¼‰
                        } else {
                            this.combo = 0;
                            this.spawnEffect(cx, cy, "MISS...", "#888", "1.5rem");
                            this.timerValue -= 15;
                            // ãƒŸã‚¹éŸ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                            this.triggerSnare(Tone.now());
                        }
                    }
                },

                resumeAudioForce() {
                    if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                        Tone.context.resume().catch(() => { });
                    }
                },

                nextQuestion() {
                    const info = this.getLevelInfo(this.currentLevel);
                    const pool = this.allNotes.filter(info.pool);
                    let nextQ;
                    let attempts = 0;
                    do {
                        nextQ = pool[Math.floor(Math.random() * pool.length)];
                        attempts++;
                    } while (pool.length > 1 && this.currentTarget && nextQ.note === this.currentTarget.note && attempts < 10);
                    this.currentTarget = nextQ;
                    this.questionStartTime = Date.now(); // [New] Reset timer
                },

                missionClear() {
                    this.stopGame();
                    this.result.isClear = true;
                    this.result.reward = Math.floor(this.score * 0.1);
                    this.savedData.gold += this.result.reward;
                    if (this.currentLevel === this.savedData.maxLevel && this.savedData.maxLevel < 50) this.savedData.maxLevel++;
                    this.saveGame();
                    setTimeout(() => this.gameState = 'result', 500);
                },
                gameOver() {
                    this.stopGame();
                    this.result.isClear = false;
                    this.result.reward = Math.floor(this.score * 0.05);
                    this.savedData.gold += this.result.reward;
                    this.saveGame();
                    this.gameState = 'result';
                },
                nextMission() {
                    this.currentLevel++;
                    this.gameState = 'briefing';
                },

                useItem(type) {
                    if (this.savedData.inventory[type] > 0 && !this.activeEffects[type]) {
                        this.savedData.inventory[type]--;
                        this.activeEffects[type] = true;
                        if (type === 'clock') setTimeout(() => this.activeEffects.clock = false, 5000);
                        this.saveGame();
                    }
                },
                spawnEffect(x, y, text, color, size = "2.5rem") {
                    const id = this.effectId++;
                    if (!x) { x = window.innerWidth / 2; y = window.innerHeight / 3; }
                    this.hitEffects.push({ id, x: x, y: y, text, color, size });
                    setTimeout(() => this.hitEffects = this.hitEffects.filter(e => e.id !== id), 600);
                },

                async initAudio() {
                    if (this.synth) return;

                    // Synth
                    this.synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 } });
                    this.distortion = new Tone.Distortion(0).toDestination();
                    this.filter = new Tone.Filter(2000, "lowpass").toDestination();
                    this.reverb = new Tone.Reverb({ decay: 1.5, preDelay: 0.01 }).toDestination();

                    // Drums (Heavy Rock)
                    this.drumKick = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }, volume: -2 }).toDestination();

                    // Snare (Noise+Tone)
                    const snareNoise = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } });
                    const snareTone = new Tone.MembraneSynth({ pitchDecay: 0, octaves: 0, oscillator: { type: "triangle" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 }, volume: -5 });
                    const snareVol = new Tone.Volume(-5).toDestination();
                    snareNoise.connect(snareVol); snareTone.connect(snareVol);
                    this.drumSnare = { noise: snareNoise, tone: snareTone };

                    this.drumHat = new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.05, release: 0.05 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5, volume: -18 }).toDestination();

                    this.setupToneGear(this.savedData.equippedGear);
                    this.setupDrumLoop();
                },

                setupDrumLoop() {
                    this.drumLoop = new Tone.Loop(time => {
                        const t8 = Tone.Time("8n").toSeconds();
                        this.drumKick.triggerAttackRelease("C1", "8n", time);
                        this.drumKick.triggerAttackRelease("C1", "8n", time + t8 * 4);
                        this.drumKick.triggerAttackRelease("C1", "8n", time + t8 * 5);
                        this.triggerSnare(time + t8 * 2);
                        this.triggerSnare(time + t8 * 6);
                        for (let i = 0; i < 8; i++) this.drumHat.triggerAttackRelease("32n", time + t8 * i, i % 2 === 0 ? 0.8 : 0.4);
                    }, "1m");
                },
                triggerSnare(time) {
                    this.drumSnare.noise.triggerAttack(time);
                    this.drumSnare.tone.triggerAttackRelease("C2", "8n", time);
                },
                setupToneGear(id) {
                    if (!this.synth) return;
                    try {
                        this.synth.disconnect();
                        this.synth.chain(this.distortion, this.filter, this.reverb, Tone.Destination);

                        this.synth.volume.value = -5;
                        if (id === 'standard') { this.synth.set({ oscillator: { type: "sawtooth" } }); this.distortion.distortion = 0.4; }
                        else if (id === 'metal') { this.synth.set({ oscillator: { type: "square" } }); this.distortion.distortion = 0.8; this.filter.frequency.value = 4000; }
                        else if (id === 'fuzz') { this.synth.set({ oscillator: { type: "square" } }); this.distortion.distortion = 1.0; this.filter.frequency.value = 1500; }
                        else if (id === 'clean') { this.synth.set({ oscillator: { type: "triangle" } }); this.distortion.distortion = 0; this.filter.frequency.value = 5000; }
                    } catch (e) { }
                },
                playPowerChord(note) {
                    if (!this.synth) return;
                    try {
                        const r = note + "2";
                        const rf = Tone.Frequency(r);
                        this.synth.triggerAttackRelease([rf, rf.transpose(7), rf.transpose(12)], "8n");
                    } catch (e) { }
                }
            }
        }).mount('#app');
    </script>
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }
    </script>
</body>

</html>